<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments :: head(
        title=${'Dettagli Booklist: ' + booklist.nome + ' • Readup'},
        pageCss='/css/pages/booklist_details_style.css',
        extraPageCss=${null},
        pageJS='/js/booklist_details.js')}">
</head>

<body>
    <header th:replace="~{fragments :: header}"></header>

    <main class="container my-4">
        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
            <span th:text="${successMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <span th:text="${errorMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/booklists}">Le Tue Booklist</a></li>
                <li class="breadcrumb-item active" aria-current="page" th:text="${booklist.nome}">Nome Booklist</li>
            </ol>
        </nav>

        <h2 class="mb-3" th:text="${booklist.nome}">Nome Booklist</h2>
        <p class="text-muted" th:if="${booklist.description}" th:text="${booklist.description}">Descrizione.</p>
        <p class="text-muted" th:unless="${booklist.description}">Nessuna descrizione per questa booklist.</p>

        <hr>

        <h3 class="mb-3">Libri in questa Booklist (<span th:text="${booklist.libri.size()}">0</span>)</h3>

        <div th:if="${#lists.isEmpty(booklist.libri)}" class="alert alert-info">
            Questa booklist non contiene ancora libri. Aggiungine uno!
        </div>
        <div th:unless="${#lists.isEmpty(booklist.libri)}" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
            <div class="col" th:each="libro : ${booklist.libri}">
                <div class="card h-100 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title" th:text="${libro.titolo}">Titolo Libro</h5>
                        <p class="card-text text-muted" th:text="${libro.autore}">Autore</p>
                        <p class="card-text">ISBN: <span th:text="${libro.isbn != null ? libro.isbn : 'N/A'}"></span></p>
                        <div th:if="${libro.isbn != null}">
                            <img th:src="@{'http://covers.openlibrary.org/b/isbn/' + ${libro.isbn} + '-M.jpg'}" alt="Cover" class="img-fluid book-cover mb-2">
                        </div>
                        </div>
                </div>
            </div>
        </div>

        <hr class="my-4">

        <h3 class="mb-3">Aggiungi un Libro a questa Booklist</h3>
        
        <button type="button" class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#addBookModal">
            Aggiungi Libro Esistente
        </button>

        <div class="modal fade" id="addBookModal" tabindex="-1" aria-labelledby="addBookModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addBookModalLabel">Aggiungi Libro</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="searchBookForm" class="mb-4">
                            <div class="input-group">
                                <input type="text" class="form-control" id="bookSearchQuery" placeholder="Cerca libro per titolo...">
                                <button class="btn btn-outline-secondary" type="submit">Cerca</button>
                            </div>
                        </form>
                        
                        <div id="searchResults" class="list-group">
                            <p class="text-muted text-center" id="noResultsMessage">Nessun libro trovato. Prova un'altra ricerca.</p>
                        </div>
                        
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <footer th:replace="~{fragments :: footer}"></footer>

    <script th:inline="javascript">
        /*<![CDATA[*/
        document.addEventListener('DOMContentLoaded', function() {
            const searchBookForm = document.getElementById('searchBookForm');
            const bookSearchQuery = document.getElementById('bookSearchQuery');
            const searchResults = document.getElementById('searchResults');
            const noResultsMessage = document.getElementById('noResultsMessage');
            const booklistId = /*[[${booklist.idBooklist}]]*/ null; // Ottieni l'ID della booklist dal modello Thymeleaf

            // Funzione per mostrare/nascondere il messaggio "Nessun risultato"
            function toggleNoResultsMessage(show) {
                noResultsMessage.style.display = show ? 'block' : 'none';
            }

            toggleNoResultsMessage(true); // Inizialmente mostra il messaggio

            searchBookForm.addEventListener('submit', function(event) {
                event.preventDefault(); // Impedisce il submit del form standard
                const query = bookSearchQuery.value.trim();

                if (query.length < 2) { // Evita ricerche troppo brevi
                    searchResults.innerHTML = '';
                    toggleNoResultsMessage(true);
                    return;
                }

                fetch('/api/libri/search?query=' + encodeURIComponent(query))
                    .then(response => response.json())
                    .then(data => {
                        searchResults.innerHTML = ''; // Pulisce i risultati precedenti
                        if (data.length > 0) {
                            toggleNoResultsMessage(false);
                            data.forEach(libro => {
                                const listItem = document.createElement('div');
                                listItem.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center');
                                listItem.innerHTML = `
                                    <div>
                                        <h6 class="mb-1">${libro.titolo}</h6>
                                        <small class="text-muted">${libro.autore}</small>
                                    </div>
                                    <form action="/booklist/${booklistId}/add-libro" method="post" class="add-libro-form">
                                        <input type="hidden" name="libroId" value="${libro.idLibro}">
                                        <button type="submit" class="btn btn-sm btn-primary">Aggiungi</button>
                                    </form>
                                `;
                                searchResults.appendChild(listItem);
                            });
                        } else {
                            toggleNoResultsMessage(true);
                        }
                    })
                    .catch(error => {
                        console.error('Errore durante la ricerca dei libri:', error);
                        searchResults.innerHTML = '<div class="alert alert-danger">Errore durante la ricerca. Riprova più tardi.</div>';
                        toggleNoResultsMessage(false); // Nasconde il messaggio di nessun risultato in caso di errore di rete
                    });
            });

            // Gestione del reindirizzamento dopo l'aggiunta di un libro
            // Questo script si esegue quando la pagina viene caricata dopo un redirect
            const addLibroModal = new bootstrap.Modal(document.getElementById('addBookModal'));
            if (/*[[${errorMessage}]]*/ null && /*[[${errorMessage}]].includes('Libro già presente')*/ false) {
                 addLibroModal.show(); // Ri-apre la modal se l'errore è dovuto a libro già presente
            }
             if (/*[[${errorMessage}]]*/ null && /*[[${errorMessage}]].includes('non trovato con ID')*/ false) {
                 addLibroModal.show(); // Ri-apre la modal se l'errore è dovuto a ID non trovato
            }
        });
        /*]]>*/
    </script>
</body>
</html>